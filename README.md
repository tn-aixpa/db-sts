# Database STS

![GitHub Actions Workflow Status](https://img.shields.io/github/actions/workflow/status/scc-digitalhub/db-sts/release.yaml?event=release) [![license](https://img.shields.io/badge/license-Apache%202.0-blue)](https://github.com/scc-digitalhub/db-sts/LICENSE) ![GitHub Release](https://img.shields.io/github/v/release/scc-digitalhub/db-sts)
![Status](https://img.shields.io/badge/status-beta-blue)

A token exchange service to obtain (temporary) db credentials from a web identity via JWT or basic auth: when an authorized client requests a set of temporary credentials, the web identity extracted from token or basic auth will be exchanged for a db ROLE derived from the default with an autogenerated secure password and an expiration date. Expired roles are periodically cleaned from the database server.
All operations are logged for auditing in an internal database (h2 or postgresql).

Currently supports only PostgreSQL as db platform.

## Quick start

The application is build and distributed at every release as

- source code tarball
- container image

To quickly start a test instance you can download the pre-built image for docker/podman via:

```sh
docker pull ghcr.io/scc-digitalhub/db-sts:latest
```

In order to launch the application you need to have a running instance of PostgreSQL (>12) with an already existing database and a ROLE suitable for user creation.

Create a `.env` configuration with the following variables set:

```sh
CONNECTION_URL="jdbc:postgresql://..."
CONNECTION_USER="username"
CONNECTION_PASS="password"
```

And use the file to launch the container via:

```sh
docker run -p 8080:8080 --env-file .env ghcr.io/scc-digitalhub/db-sts:latest
```

The application will start, check the connection to the database and then use a local H2 instance as audit database.

Read the following sections to fully configure the application.

## Configuration

The application needs a valid configuration for the database adapter, and at minimum a source of web identity, i.e. a provider between basic and jwt.

| KEY               | DESCRIPTION                                                       | DEFAULT |
| ----------------- | ----------------------------------------------------------------- | ------- |
| CONNECTION_URL    | JDBC url for connecting to the database server                    |         |
| CONNECTION_PASS   | Password for the database connection                              |         |
| CONNECTION_USER   | Username for the database connection                              |         |
| CONNECTION_POLICY | Policy used to expire the temporary credentials                   | expire  |
| POSTGRES_DATABASE | Database used for roles. Defaults to the one specified in the URL |         |

For identity providers, configure the following. When no JWT issuer is configured, only requests with a valid client authentication are processed.

| KEY                | DESCRIPTION                             | DEFAULT |
| ------------------ | --------------------------------------- | ------- |
| STS_CLIENT_ID      | client id for client authentication     |         |
| STS_CLIENT_SECRET  | client secret for client authentication |         |
| STS_JWT_ISSUER_URI | (OAuth2/OIDC) Issuer for JWT tokens     |         |
| STS_JWT_AUDIENCE   | Audience for token validation           | sts     |

In order to persist the audit database, create a different database in PostgreSql and then provide the details to replace the embedded H2 store. Do note that for security reasons it is strongly recommended to keep the audit database separated from the one used for adapter connection.

| KEY           | DESCRIPTION                       | DEFAULT                |
| ------------- | --------------------------------- | ---------------------- |
| JDBC_PLATFORM | Platform name: h2 or postgresql   | h2                     |
| JDBC_URL      | JDBC url for connecting to the db | jdbc:h2:file:./data/db |
| JDBC_DRIVER   | JDBC Driver for db connection     | org.h2.Driver          |
| JDBC_PASS     | Password for the db connection    | password               |
| JDBC_USER     | Username for the db connection    | sa                     |

Credentials configuration is customizable via the following parameters.

| KEY                        | DESCRIPTION                                                                    | DEFAULT |
| -------------------------- | ------------------------------------------------------------------------------ | ------- |
| STS_CREDENTIALS_DURATION   | Duration in seconds                                                            | 28800   |
| STS_CREDENTIALS_ROLES      | Roles assigned by default, enables requests without the role parameter to work |         |
| STS_CREDENTIALS_PWD_LENGTH | Password length for temporary credentials                                      | 12      |

## Development

The application is built on a Java + Spring Boot stack, leveraging JDBC for database connections and Maven as dependency and build manager.

If you have the following requirements you can test and build from sources.

Requirements:

- Java 21
- Maven 3.8
- Docker (to build a container image)

To install all the dependencies you can use [SDKMAN](https://sdkman.io/):

```sh
curl -s "https://get.sdkman.io" | bash
```

and then

```sh
sdk install java
sdk install maven
```

Follow the [installation docs](https://sdkman.io/install) for more information on initializing a suitable development environment.

See CONTRIBUTING for contribution instructions.

### Build from source

In order to build core from source clone the project into a folder.

```sh
git clone https://github.com/scc-digitalhub/db-sts.git
```

And then build the sources with Maven:

```sh
./mvnw clean package

```

When finished, you can run the application via:

```
./mvnw spring-boot:run
```

Don't forget to configure the properties required for the database adapter: pass the ENV variables or build an application profile `application-local.yaml` to use. Without a valid database connection, the application won't start.

Do note that running the application from source is advisable only for developing new features or debugging issues.

### Build container images

To make a local container image, use the `Dockerfile` included with the project

```sh
docker built -t db-sts:snapshot -f Dockerfile .
```

and then run it as container:

```
docker run -p 8080:8080 core:db-sts
```

Don't forget to configure the properties required for the database adapter: pass the ENV variables or the application won't start.

## Security Policy

The current release is the supported version. Security fixes are released together with all other fixes in each new release.

If you discover a security vulnerability in this project, please do not open a public issue.

Instead, report it privately by emailing us at dslab@fbk.eu. Include as much detail as possible to help us understand and address the issue quickly and responsibly.

## Contributing

To report a bug or request a feature, please first check the existing issues to avoid duplicates. If none exist, open a new issue with a clear title and a detailed description, including any steps to reproduce if it's a bug.

To contribute code, start by forking the repository. Clone your fork locally and create a new branch for your changes. Make sure your commits follow the [Conventional Commits v1.0](https://www.conventionalcommits.org/en/v1.0.0/) specification to keep history readable and consistent.

Once your changes are ready, push your branch to your fork and open a pull request against the main branch. Be sure to include a summary of what you changed and why. If your pull request addresses an issue, mention it in the description (e.g., “Closes #123”).

Please note that new contributors may be asked to sign a Contributor License Agreement (CLA) before their pull requests can be merged. This helps us ensure compliance with open source licensing standards.

We appreciate contributions and help in improving the project!

## Authors

This project is developed and maintained by **DSLab – Fondazione Bruno Kessler**, with contributions from the open source community. A complete list of contributors is available in the project’s commit history and pull requests.

For questions or inquiries, please contact: [dslab@fbk.eu](mailto:dslab@fbk.eu)

## Copyright and license

Copyright © 2025 DSLab – Fondazione Bruno Kessler and individual contributors.

This project is licensed under the Apache License, Version 2.0.
You may not use this file except in compliance with the License. Ownership of contributions remains with the original authors and is governed by the terms of the Apache 2.0 License, including the requirement to grant a license to the project.
